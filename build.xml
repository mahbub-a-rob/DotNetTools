<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Default">
    <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" />
    <!-- TODO use common build lifecycle -->
    <Import Project="build\common.props" />

    <!-- build project dependencies -->
    <PropertyGroup>
        <RestoreSources>$(RestoreSources);https://dotnet.myget.org/F/aspnetcore-tools/api/v3/index.json</RestoreSources>
        <!-- this build project targets netcoreapp1.0 so it can restore build targets, but doesn't actually compile sources -->
        <TargetFramework>netcoreapp1.0</TargetFramework>
    </PropertyGroup>
    <ItemGroup>
        <PackageReference Include="NuGetPackageVerifier" Version="1.0.1-*" />
    </ItemGroup>

    <!-- build settings -->
    <PropertyGroup>
        <SolutionFile>$(MSBuildThisFileDirectory)DotNetTools.sln</SolutionFile>

        <ArtifactsPath>$(MSBuildThisFileDirectory)artifacts\build\</ArtifactsPath>

        <!-- required for Microsoft.Common.targets configuration validation -->
        <OutputPath>$(ArtifactsPath)</OutputPath>

        <Configuration Condition="'$(Configuration)'==''">Debug</Configuration>
        <ProjectProperties>Configuration=$(Configuration)</ProjectProperties>
        <ProjectProperties Condition="'$(Version)'!=''">$(ProjectProperties);Version=$(Version)</ProjectProperties>
    </PropertyGroup>

    <ItemGroup>
        <Projects Include="src\*\*.csproj" Pack="true" />

        <!-- unit test projects before functional test projects-->
        <Projects Include="test\*\*.Test*.csproj" Test="true" />
        <Projects Include="test\*\*.csproj" Exclude="@(Projects)" Test="true" />
    </ItemGroup>

    <Target Name="Initialize">
        <Message Importance="High" Text="Build settings:" />
        <Message Importance="High" Text="DotnetCliVersion: $(DotnetCliVersion)" />
        <MSBuild Projects="$(SolutionFile)"
                 Targets="Restore"
                 Properties="$(ProjectProperties)" />
    </Target>

    <Target Name="Pack">
        <ItemGroup>
            <_PackProjects Include="@(Projects)" Condition=" %(Projects.Pack) == 'true'" />
        </ItemGroup>
        <MSBuild Targets="Pack"
                 Projects="@(_PackProjects)"
                 Properties="PackageOutputPath=$(ArtifactsPath);$(ProjectProperties)"/>
        <!-- TODO BuildInParallel when Microsoft.NET.Sdk fixes race conditions -->
    </Target>

    <Target Name="Test">
        <ItemGroup>
            <_TestProjects Include="@(Projects)" Condition=" %(Projects.Test) == 'true'" />
        </ItemGroup>
        <MSBuild Targets="VSTest"
                 Projects="@(_TestProjects)"
                 Properties="$(ProjectProperties)" />
    </Target>

    <!-- required to import the restore target -->
    <Import Project="$(MSBuildExtensionsPath)\Microsoft.Common.targets" />

    <!-- targets that extend/override default common targets need to come after importing common targets -->
    <Target Name="Compile">
        <MSBuild Targets="Build"
                 Projects="$(SolutionFile)"
                 Properties="$(ProjectProperties)"
                 />
        <!-- TODO BuildInParallel when Microsoft.NET.Sdk fixes race conditions -->
    </Target>

    <Target Name="AfterClean">
        <RemoveDir Directories="$(ArtifactsPath);$(MSBuildThisFileDirectory)testWorkDir" />
        <MSBuild Targets="Clean"
                 Projects="$(SolutionFile)"
                 Properties="$(ProjectProperties)" />
        <!-- TODO BuildInParallel when Microsoft.NET.Sdk fixes race conditions -->
    </Target>

    <Target Name="Default" DependsOnTargets="Initialize;Clean;Compile;Test;Pack" />
</Project>